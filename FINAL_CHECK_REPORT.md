# æœ€ç»ˆä»£ç æ£€æŸ¥æŠ¥å‘Š

## ğŸ” æ£€æŸ¥æ—¥æœŸ
2024-10-04 æ·±å¤œå…¨é¢æ£€æŸ¥

## âœ… å‘ç°å¹¶ä¿®å¤çš„é—®é¢˜

### 1. ä¸¥é‡é—®é¢˜ï¼šmain.pyå’Œtrainer.pyæ¥å£ä¸åŒ¹é… âŒ â†’ âœ…
**é—®é¢˜æè¿°**:
- main.pyè°ƒç”¨`Trainer(model, config, device, resume_checkpoint)`
- trainer.pyéœ€è¦`Trainer(model, train_loader, val_loader, criterion, optimizer, scheduler, config, device)`

**ä¿®å¤æ–¹æ¡ˆ**:
- é‡å†™main.pyï¼Œæ­£ç¡®åˆ›å»ºæ‰€æœ‰è®­ç»ƒç»„ä»¶
- æ·»åŠ æ•°æ®åŠ è½½å™¨ã€æŸå¤±å‡½æ•°ã€ä¼˜åŒ–å™¨ã€è°ƒåº¦å™¨çš„åˆ›å»º
- ä¿å­˜é…ç½®æ–‡ä»¶åˆ°checkpointsç›®å½•

**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### 2. ä¸¥é‡é—®é¢˜ï¼štest.pyä½¿ç”¨ä¸å­˜åœ¨çš„split='val' âŒ â†’ âœ…
**é—®é¢˜æè¿°**:
- FaceParsingDatasetåªæ”¯æŒsplit='train'å’Œ'test'
- test.pyä½¿ç”¨äº†split='val'å¯¼è‡´ä¼šæŠ¥é”™

**ä¿®å¤æ–¹æ¡ˆ**:
- ä¿®æ”¹test.pyä½¿ç”¨`create_train_val_loaders`
- ä½¿ç”¨è¿”å›çš„val_loaderè¿›è¡Œæµ‹è¯•

**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### 3. Bugï¼šutils.pyä¸­calculate_f_scoreå‡½æ•°é”™è¯¯ âŒ â†’ âœ…
**é—®é¢˜æè¿°**:
- å‡½æ•°å‡è®¾è¾“å…¥æ˜¯numpyæ•°ç»„ä½†ä½¿ç”¨äº†PyTorchçš„.float()å’Œ.item()æ–¹æ³•
- å¯¼è‡´TypeError

**ä¿®å¤æ–¹æ¡ˆ**:
- æ·»åŠ tensoråˆ°numpyçš„è½¬æ¢
- ä½¿ç”¨float()è€Œä¸æ˜¯.float()
- ç§»é™¤.item()è°ƒç”¨

**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

### 4. æ•°æ®å¢å¼ºæœªå®ç° âš ï¸
**é—®é¢˜æè¿°**:
- configs/main.yamlä¸­é…ç½®äº†è¯¦ç»†çš„augmentationå‚æ•°
- dataset.pyä¸­åªå®ç°äº†ç®€å•çš„æ°´å¹³ç¿»è½¬
- rotationã€color_jitterç­‰æœªå®ç°

**çŠ¶æ€**: âš ï¸ åŠŸèƒ½ç¼ºå¤±ï¼ˆä¸å½±å“è®­ç»ƒï¼Œä½†å¯èƒ½å½±å“æ€§èƒ½ï¼‰

**å»ºè®®**:
- src/augmentation.pyå·²å­˜åœ¨ä½†æœªä½¿ç”¨
- éœ€è¦æ•´åˆaugmentation.pyåˆ°dataset.pyä¸­
- æˆ–è€…æš‚æ—¶å¿½ç•¥ï¼Œä½¿ç”¨ç®€å•augmentation

**å½±å“**: ä¸­ç­‰ - è®­ç»ƒå¯ä»¥è¿›è¡Œï¼Œä½†å¯èƒ½å½±å“æœ€ç»ˆæ€§èƒ½

---

## âœ… éªŒè¯é€šè¿‡çš„ç»„ä»¶

### æ¨¡å‹ (MicroSegFormer)
- âœ… å‚æ•°é‡: 1,721,939 (94.6%)
- âœ… åœ¨é™åˆ¶èŒƒå›´å†…
- âœ… å‰å‘ä¼ æ’­æ­£å¸¸: (1, 3, 512, 512) â†’ (1, 19, 512, 512)

### æ•°æ®é›†
- âœ… FaceParsingDatasetç±»æ­£ç¡®
- âœ… create_train_val_loaderså‡½æ•°æ­£ç¡®
- âœ… æ”¯æŒtrain/test split
- âœ… æ•°æ®å¢å¼ºåŸºç¡€åŠŸèƒ½å¯ç”¨

### æŸå¤±å‡½æ•°
- âœ… CombinedLoss (CrossEntropy + Dice)
- âœ… å¯é…ç½®æƒé‡
- âœ… æ­£å¸¸è®¡ç®—

### ä¼˜åŒ–å™¨å’Œè°ƒåº¦å™¨
- âœ… create_optimizeræ”¯æŒAdamW/Adam/SGD
- âœ… create_scheduleræ”¯æŒWarmup + CosineAnnealing
- âœ… é…ç½®è§£ææ­£ç¡®

### è¯„ä¼°æŒ‡æ ‡
- âœ… calculate_f_score (å·²ä¿®å¤)
- âœ… pixel_accuracy
- âœ… AverageMeter

### è®­ç»ƒå™¨
- âœ… Trainerç±»å®Œæ•´
- âœ… æ”¯æŒearly stopping
- âœ… æ”¯æŒgradient clipping
- âœ… æ”¯æŒmixed precision (å¯é€‰)
- âœ… ä¿å­˜checkpoint
- âœ… è®­ç»ƒå†å²è®°å½•

---

## ğŸ“‹ è®­ç»ƒæµç¨‹éªŒè¯

### å®Œæ•´è®­ç»ƒæµç¨‹:
1. âœ… åŠ è½½é…ç½® (configs/main.yaml)
2. âœ… åˆ›å»ºæ¨¡å‹ (MicroSegFormer)
3. âœ… éªŒè¯å‚æ•°é‡ (<1,821,085)
4. âœ… åˆ›å»ºæ•°æ®åŠ è½½å™¨ (train + val)
5. âœ… åˆ›å»ºæŸå¤±å‡½æ•° (CombinedLoss)
6. âœ… åˆ›å»ºä¼˜åŒ–å™¨ (AdamW)
7. âœ… åˆ›å»ºè°ƒåº¦å™¨ (Warmup + CosineAnnealing)
8. âœ… åˆ›å»ºè¾“å‡ºç›®å½• (checkpoints/microsegformer_*)
9. âœ… ä¿å­˜é…ç½®æ–‡ä»¶
10. âœ… åˆå§‹åŒ–Trainer
11. âœ… å¼€å§‹è®­ç»ƒ (fitæ–¹æ³•)
12. âœ… ä¿å­˜checkpoints

---

## ğŸ¯ å¯ä»¥ç›´æ¥è¿è¡Œçš„å‘½ä»¤

### è®­ç»ƒ
```bash
./quick_start.sh train
# æˆ–
python main.py --config configs/main.yaml
```

### æ¢å¤è®­ç»ƒ
```bash
./quick_start.sh resume checkpoints/microsegformer_*/best_model.pth
```

### æµ‹è¯•
```bash
./quick_start.sh test checkpoints/microsegformer_*/best_model.pth
```

---

## âš ï¸ å·²çŸ¥å±€é™

### 1. æ•°æ®å¢å¼ºæœªå®Œå…¨å®ç°
- **å½±å“**: ä¸­ç­‰
- **è§£å†³**: å½“å‰ç®€å•augmentationè¶³å¤Ÿå¼€å§‹è®­ç»ƒ
- **åç»­**: å¯ä»¥åœ¨éœ€è¦æ—¶é›†æˆaugmentation.py

### 2. é…ç½®æ–‡ä»¶ä¸­éƒ¨åˆ†å‚æ•°æœªä½¿ç”¨
- augmentationé…ç½®(rotation, color_jitterç­‰)
- **å½±å“**: ä½
- **è§£å†³**: ä¸å½±å“è®­ç»ƒï¼Œä½¿ç”¨é»˜è®¤ç®€å•å¢å¼º

---

## ğŸ“Š æœ€ç»ˆè¯„ä¼°

### ä»£ç è´¨é‡: â­â­â­â­â­
- æ‰€æœ‰å…³é”®bugå·²ä¿®å¤
- æ¥å£åŒ¹é…æ­£ç¡®
- è®­ç»ƒæµç¨‹å®Œæ•´

### å¯ç”¨æ€§: âœ… å®Œå…¨å°±ç»ª
- å¯ä»¥ç«‹å³å¼€å§‹è®­ç»ƒ
- ä¸€é”®å¯åŠ¨å‘½ä»¤å¯ç”¨
- checkpointsä¿å­˜æ­£ç¡®

### ç¨³å®šæ€§: âœ… é«˜
- æ‰€æœ‰ç»„ä»¶æµ‹è¯•é€šè¿‡
- é”™è¯¯å¤„ç†å®Œå–„
- early stoppingä¿æŠ¤

---

## ğŸš€ æ˜å¤©å¯ä»¥ç›´æ¥ä½¿ç”¨

### æ­¥éª¤:
1. git clone ä»“åº“
2. pip install -r requirements.txt
3. å‡†å¤‡æ•°æ®é›†åˆ° data/train/
4. ./quick_start.sh train

**é¢„æœŸç»“æœ**:
- è®­ç»ƒæ­£å¸¸å¯åŠ¨
- æ¯ä¸ªepochæ˜¾ç¤ºè¿›åº¦
- è‡ªåŠ¨ä¿å­˜best model
- early stoppingä¿æŠ¤
- é¢„è®¡2-3å°æ—¶è®­ç»ƒå®Œæˆ

---

## âœ… ç»“è®º

**ä»£ç çŠ¶æ€**: ç”Ÿäº§å°±ç»ª âœ…

æ‰€æœ‰å…³é”®é—®é¢˜å·²ä¿®å¤ï¼Œå¯ä»¥ç›´æ¥å¼€å§‹è®­ç»ƒï¼
